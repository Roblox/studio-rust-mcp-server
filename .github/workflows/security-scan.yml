name: Security Scan

on:
    pull_request:
    push:
        branches:
        - main
    schedule:
        - cron: '0 2 * * 1'  # Weekly on Mondays at 2 AM

jobs:
    codeql-analysis:
        name: CodeQL Analysis
        runs-on: ubuntu-latest
        permissions:
            actions: read
            contents: read
            security-events: write

        strategy:
            fail-fast: false
            matrix:
                language: [ 'rust' ]

        steps:
        - name: Checkout repository
          uses: actions/checkout@v4

        - name: Initialize CodeQL
          uses: github/codeql-action/init@v3
          with:
            languages: ${{ matrix.language }}
            queries: security-extended,security-and-quality

        - name: Autobuild
          uses: github/codeql-action/autobuild@v3

        - name: Perform CodeQL Analysis
          uses: github/codeql-action/analyze@v3
          with:
            category: "/language:${{matrix.language}}"

    dependency-review:
        name: Dependency Review
        runs-on: ubuntu-latest
        if: github.event_name == 'pull_request'
        steps:
          - name: Checkout repository
            uses: actions/checkout@v4
          - name: Dependency Review
            uses: actions/dependency-review-action@v4

    secrets-scan:
        name: Secrets Scan
        runs-on: ubuntu-latest
        steps:
          - name: Checkout repository
            uses: actions/checkout@v4
            with:
              fetch-depth: 0

          - name: Run Gitleaks
            uses: gitleaks/gitleaks-action@v2
            env:
              GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_KEY }}

    cargo-audit:
        name: Cargo Audit
        runs-on: ubuntu-latest
        continue-on-error: false
        steps:
          - name: Checkout repository
            uses: actions/checkout@v4
          
          - name: Install Rust
            uses: dtolnay/rust-toolchain@stable
            with:
              components: rust-src
          
          - name: Install cargo-audit
            run: cargo install cargo-audit
          
          - name: Run cargo audit
            run: cargo audit --ignore RUSTSEC-2024-0375 --ignore RUSTSEC-2021-0145 --ignore RUSTSEC-2020-0016 --ignore RUSTSEC-2024-0436 --ignore RUSTSEC-2024-0370
            continue-on-error: true
          
          - name: Generate security report
            if: failure()
            run: |
              echo "## ðŸ”’ Security Audit Report" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### Vulnerabilities Found:" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              cargo audit --format json | jq -r '.vulnerabilities[]? | "- **\(.package)**: \(.title) (ID: \(.id))"' >> $GITHUB_STEP_SUMMARY || echo "- No vulnerabilities found" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### Warnings:" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              cargo audit --format json | jq -r '.warnings[]? | "- **\(.package)**: \(.title) (ID: \(.id))"' >> $GITHUB_STEP_SUMMARY || echo "- No warnings found" >> $GITHUB_STEP_SUMMARY

    dependency-check:
        name: Dependency Security Check
        runs-on: ubuntu-latest
        steps:
          - name: Checkout repository
            uses: actions/checkout@v4
          
          - name: Install Rust
            uses: dtolnay/rust-toolchain@stable
            with:
              components: rust-src
          
          - name: Install cargo-outdated
            run: cargo install cargo-outdated
          
          - name: Check for outdated dependencies
            run: |
              echo "## ðŸ“¦ Dependency Update Report" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### Outdated Dependencies:" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              cargo outdated --format json | jq -r '.packages[]? | select(.latest_version != .version) | "- **\(.name)**: \(.version) â†’ \(.latest_version) (\(.latest_date))"' >> $GITHUB_STEP_SUMMARY || echo "- All dependencies are up to date" >> $GITHUB_STEP_SUMMARY

    security-summary:
        name: Security Summary
        runs-on: ubuntu-latest
        needs: [codeql-analysis, dependency-review, secrets-scan, cargo-audit, dependency-check]
        if: always()
        steps:
          - name: Generate security summary
            run: |
              echo "## ðŸ›¡ï¸ Security Scan Summary" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
              echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
              echo "| CodeQL Analysis | ${{ needs.codeql-analysis.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
              echo "| Dependency Review | ${{ needs.dependency-review.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
              echo "| Secrets Scan | ${{ needs.secrets-scan.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
              echo "| Cargo Audit | ${{ needs.cargo-audit.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
              echo "| Dependency Check | ${{ needs.dependency-check.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Overall Status**: ${{ (needs.codeql-analysis.result == 'success' && needs.secrets-scan.result == 'success' && needs.cargo-audit.result == 'success') && 'âœ… Secure' || 'âš ï¸ Issues Found' }}" >> $GITHUB_STEP_SUMMARY
